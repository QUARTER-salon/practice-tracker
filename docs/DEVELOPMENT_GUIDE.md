# 美容師練習管理Webアプリ 開発・運用ガイド (ローカル開発環境版)

## 1. はじめに：このガイドの目的

このガイドは、「美容師練習管理Webアプリ」の開発を、ローカル開発環境（VS Code, Git, clasp）を使用して効率的かつ安全に進めるための手順を説明するものです。

当初、`clasp push` コマンドに関する問題がありましたが、現在は解決済みであり、ローカル環境を主軸とした開発を行います。このガイドでは、ローカルでのコード編集、Gitによるバージョン管理、clasp を用いた Google Apps Script (GAS) プロジェクトとの連携、そしてテスト・デプロイまでの標準的なフローを示します。

## 2. 開発環境

*   **コードエディタ:** Visual Studio Code (VS Code) - 拡張機能 (Prettier, ESLint など推奨)
*   **バージョン管理:** Git, GitHub (または他のGitリポジトリサービス)
*   **GAS連携ツール:** clasp (`npm install -g @google/clasp` でインストール)
*   **実行環境:** Node.js (clasp の実行に必要)
*   **Webブラウザ:** Google Chrome推奨 (動作確認、デバッグ、GASエディタ補助利用)
*   **Googleアカウント:** 開発権限のあるGoogle Workspaceアカウント (例: yujiro-funabashi@4uwb.com)
*   **Google Drive:** GASプロジェクトファイルの実体保管場所
*   **Google スプレッドシート:** アプリのデータベース（スタッフマスター、練習記録、在庫、各種マスター）

---

## 3. 開発プロジェクトの準備

安全な開発のため、必ずテスト用の環境を用意し、そこで開発・テストを行ってから本番環境に反映させます。

1.  **テスト用/本番用スプレッドシートの準備:**
    *   本番運用で使用するスプレッドシートとは別に、**テスト専用**のGoogleスプレッドシートファイルを作成します。（例: `[テスト用]美容師練習管理データ`）
    *   両方のスプレッドシート内に、要件定義に基づいた必要なシート（スタッフマスター, アプリ練習記録_RAW, ウィッグ在庫, 各種マスター）を作成し、ヘッダー行やテスト用のダミーデータを入力します。
    *   **テスト用** および **本番用** の両方の **スプレッドシートID** を控えておきます。（URLの `/d/` と `/edit` の間の文字列）

2.  **ローカル開発ディレクトリの準備 (テスト用):**
    *   ローカルPCにテスト開発用のディレクトリ（フォルダ）を作成します。場所はどこでも構いません。
    *   ターミナルを開き、以下のコマンドでディレクトリを作成し、その中に移動します。
        ```bash
        # ディレクトリを作成したい場所に移動 (例: Documentsフォルダへ)
        cd Documents

        # テスト用プロジェクトディレクトリを作成
        mkdir テスト練習アプリ

        # 作成したディレクトリに移動
        cd テスト練習アプリ
        ```
    *(注: 本番環境用のローカルディレクトリは別途 `練習WEBアプリ` として管理します)*

3.  **Gitリポジトリの初期化 (テスト用):**
    *   作成した `テスト練習アプリ` ディレクトリ内でGitの管理を開始します。
        ```bash
        git init
        ```

4.  **GitHub リモートリポジトリの準備:**
    *   GitHubのウェブサイトで、テスト用のリポジトリ **`practice-tracker`** と、本番用のリポジトリ **`trainingwebapp`** を作成します (両方とも **Private** を推奨)。
    *   作成時には README, .gitignore, license を **追加しないでください** (空のリポジトリとして作成)。

5.  **GASプロジェクトとローカル環境の紐付け (テスト用):**
    *   **A) 新規プロジェクトの場合:**
        1.  `テスト練習アプリ` ディレクトリにいることを確認します。
        2.  `clasp login` でGoogleアカウントにログインします (未ログインの場合)。
        3.  `clasp create --title "[テスト用]練習管理アプリBackend" --rootDir ./src` のように実行し、**テスト用**GASプロジェクトを新規作成し、ローカルと紐付けます。
        4.  作成された**テスト用スクリプトID** を控えます。
    *   **B) 既存プロジェクトの場合:**
        1.  `テスト練習アプリ` ディレクトリにいることを確認します。
        2.  `clasp login` (未ログインの場合)。
        3.  準備済みの **テスト用GASプロジェクトのスクリプトID** を使って、`clasp clone <テスト用スクリプトID> --rootDir ./src` を実行し、コードをローカル (`テスト練習アプリ/src`) に取得します。
        4.  `.clasp.json` が `テスト練習アプリ` 直下に作成されます。

6.  **設定ファイルの準備 (テスト用):**
    *   `.clasp.json`: `clone` または `create` で自動生成されます。**テスト用スクリプトID** が設定されていることを確認します。**Git管理対象外にするため、`.gitignore` に追加します。**
    *   `.gitignore`: **`テスト練習アプリ`** ディレクトリ直下に `.gitignore` ファイルを作成し、以下の内容を記述・保存します。(VS Code等で作成)
        ```gitignore
        # clasp 設定ファイル (環境依存)
        .clasp.json

        # Node.js モジュール (もし使う場合)
        node_modules/

        # OS 生成ファイル
        .DS_Store
        Thumbs.db

        # VS Code 設定
        .vscode/
        ```
    *   `appsscript.json`: `src` ディレクトリ内に存在します (`clone`した場合)。必要に応じてVS Codeで編集します (タイムゾーン、OAuthスコープ等)。

7.  **ローカルリポジトリとGitHubリポジトリの接続 (テスト用):**
    *   `テスト練習アプリ` ディレクトリ内で、以下のコマンドを実行します (`your-username` はご自身のGitHubユーザー名に置き換えてください)。
        ```bash
        # リモートリポジトリを追加 (テスト用: practice-tracker)
        git remote add origin https://github.com/your-username/practice-tracker.git

        # ブランチ名を main に変更 (任意)
        git branch -M main

        # 最初のコミット (まだ何もコミットしていない場合)
        git add .
        git commit -m "Initial commit: Setup project structure and clone test GAS project"

        # ローカルの main ブランチの内容をリモートの origin (practice-tracker) にプッシュ
        git push -u origin main
        ```

8.  **ローカルコードの初期設定 (テスト用):**
    *   VS Code で **`テスト練習アプリ`** フォルダを開きます。
    *   `src/Code.gs` などの設定ファイルで、参照するスプレッドシートIDを **テスト用スプレッドシートID** に設定します。`IS_PRODUCTION` フラグは `false` のままにします。
        ```javascript
        // 例: src/Code.gs
        const IS_PRODUCTION = false; // テスト環境なので false

        const SPREADSHEET_ID = IS_PRODUCTION
          ? '【本番用スプレッドシートIDをここに記述】'
          : '【テスト用スプレッドシートIDをここに記述】'; // ← テスト用IDを設定

        // シート名なども定数化推奨
        const STAFF_MASTER_SHEET_NAME = 'スタッフマスター';
        // ... 他のシート名定数
        ```
    *   変更を保存し、`git commit` で記録後、`clasp push` でテスト用GASプロジェクトに反映させ、動作確認します。

---

### 【補足】

*   これでテスト環境（ローカル `テスト練習アプリ` <-> GitHub `practice-tracker` <-> テスト用GASプロジェクト）の準備が整いました。
*   本番環境用のローカルディレクトリ (`練習WEBアプリ`) のセットアップは、テスト環境での開発・テストが完了し、本番デプロイする段階で行います。その際は、GitHubリポジトリ `trainingwebapp` と本番用GASプロジェクトに接続するように設定します。
*   以降のガイド内の「プロジェクトフォルダ」「ローカルディレクトリ」は、当面の間 **`テスト練習アプリ`** を指すものとして読み進めてください。

---

## 4. 開発の進め方と現在の進捗

要件定義書に基づき、以下のステップで機能実装を進めます。すべてのコード編集は **VS Code** で行い、**Git** でバージョン管理し、**`clasp push`** でテスト環境のGASプロジェクトに反映させながら進めます。

### **【進捗：実施中 - 動作確認で問題発生中】Step 0: コード基盤の整理と安定化 (最優先)**

*   **目的:** 開発を本格化する前に、コードの保守性・安定性を高めるための基礎を固めます。（要件定義書の保守性・拡張性原則に基づく）
*   **完了した作業:**
    *   コードのリファクタリング（設定値管理改善、関数整理、バグ修正、エラー処理強化）を実施。
    *   関連ファイル (`code.js`, `Auth.js`, `Utils.js`, `AdminHandler.js`, `DataAccess.js`) を修正済み。
    *   変更内容はGitにコミットし、`clasp push` でテスト用GASプロジェクトに反映済み。
    *   デバッグのため、各所に `Logger.log` を追加済み。
*   **現状:**
    *   `clasp deploy` でデプロイしたWebアプリの動作確認中に、**ログイン後にアプリ画面が表示されない問題** が発生している。
*   **次のアクション:** ログイン後の画面表示問題を解決する。（詳細は後述の課題セクション参照）

### **現在の課題: ログイン後の画面表示不具合**

*   **現象:**
    *   Google認証またはID/PW認証でのログイン処理自体は、バックエンドのログで成功を確認。セッション情報も正しく設定されている。
    *   しかし、ログイン成功後に表示されるべきアプリ画面 (`app.html`) が表示されず、画面が真っ白になるか、ブラウザによっては「接続が拒否されました」というエラーが表示される。
*   **調査で判明していること (GASログ分析):**
    *   ログイン成功後、フロントエンド (`index.html`) から画面遷移が試みられている (`window.location.reload()` など)。
    *   画面遷移によって再度 `doGet` 関数が呼び出されている。
    *   `doGet` 関数はセッション情報を正しく取得できている。
    *   **しかし、`doGet` 関数がURLパラメータ (`?page=app`) やセッションフラグ (`redirectToApp`) を正しく認識できておらず、結果的に `page` がデフォルトの `'index'` となり、再度ログイン画面 (`index.html`) の処理を行ってしまっている。**
    *   これにより、リダイレクトループのような状態が発生している可能性がある。
*   **試した主な対策:**
    *   `appsscript.json` の `executeAs` を `USER_ACCESSING` に変更し、必要な `oauthScopes` を追加、再デプロイ済み。
    *   スプレッドシートの共有設定で、アクセスするユーザーに編集者権限を付与済み。
    *   フロントエンドからの画面遷移方法を変更:
        *   `window.location.href = '?page=app'`
        *   `window.location.replace('<?= ScriptApp.getService().getUrl() ?>?page=app')`
        *   非表示の `<a>` タグを作成し `.click()` で遷移
        *   セッションフラグ (`redirectToApp`) を利用し、フロントは `window.location.reload()` を実行
    *   上記いずれの方法でも、遷移後の `doGet` が `page=app` を認識できない問題は解決していない。
*   **次のアクション:**
    *   現状のコード、ログ、試行内容を専門家に共有し、`USER_ACCESSING` モードでの画面遷移と `doGet` のパラメータ/セッション処理に関するアドバイスを求める。

### **【進捗：未着手】Step 1: 機能実装と連携テスト**

*   **目的:** 要件定義に基づき、未実装の機能を実装し、フロントエンドとバックエンドを連携させて動作を確認する。
*   **具体的な作業 (VS Code & ブラウザ):**
    1.  **機能実装:** パスワード認証（ハッシュ化含む）、管理者画面の各CRUD操作詳細、動的な選択肢表示ロジック、在庫更新ロジックなどを実装。
    2.  **コード編集 (VS Code):** `.gs` (バックエンド), `.html` (フロントエンド JS/CSS含む) ファイルを編集。
    3.  **記録と反映:** `git commit` -> `clasp push` (テスト環境へ)。
    4.  **連携テスト (ブラウザ):**
        *   `clasp open` でテスト用GASプロジェクトのブラウザエディタを開く。
        *   [デプロイ] > [テスト導入] を実行し、表示される **開発用URL** を開く。
        *   要件定義の各機能（ログイン、情報自動表示、トレーナー選択、動的項目、データ送信、記録確認、在庫確認、管理者操作など）が仕様通り動作するか、**徹底的にテスト**する。
        *   ブラウザの開発者ツール（Console, Networkタブ）でエラーや通信状況を確認。
        *   `Logger.log()` を使ったバックエンドのデバッグ情報をGASエディタの [実行数] で確認。
    5.  問題があれば VS Code に戻り修正、再度 Push してテスト、を繰り返す。

### **【進捗：未着手】Step 2: UI/UX 調整とエラーハンドリング強化**

*   **目的:** スマートフォンでの使いやすさ向上、エラー発生時のユーザー体験と開発者のデバッグ効率向上。
*   **具体的な作業 (VS Code & ブラウザ):**
    1.  **レスポンシブ対応:** スマートフォン実機やブラウザの開発者ツールで表示を確認し、`styles.html` (CSS) を調整。
    2.  **エラーハンドリング:** `try...catch` 構文を適切に配置し、ユーザー向けのエラーメッセージ（例: `alert()`, 画面表示）と、開発者向けのログ出力 (`Logger.log` や Stackdriver Logging) を充実させる。`google.script.run` の `.withFailureHandler()` を活用。
    3.  **入力バリデーション:** フロントエンド (JavaScript) での基本的なチェックに加え、バックエンド (GAS) でも受け取ったデータの妥当性を再度検証するコードを追加。
    4.  **記録と反映・テスト:** Step 1 と同様のサイクル (編集 -> commit -> push -> テスト導入URLで確認)。

### **【進捗：未着手】Step 3: コードレビューとリファクタリング**

*   **目的:** 実装したコード全体を見直し、品質、可読性、保守性をさらに向上させる。
*   **具体的な作業 (VS Code & GitHub):**
    1.  **自己レビュー/相互レビュー:** コード全体を読み返し、冗長な部分、複雑すぎる部分、コメント不足などを改善。可能であれば他の開発者にレビューを依頼 (GitHubのPull Request機能など活用)。
    2.  **リファクタリング:** レビュー結果に基づき、コードを整理・改善。
    3.  **記録:** `git commit`。

### **【進捗：未着手】Step 4: 本番デプロイ**

*   **目的:** テスト済みのアプリケーションを本番環境で利用可能にする。
*   **具体的な作業 (VS Code & ターミナル):**
    1.  **本番環境準備:** 本番用スプレッドシートのデータ（特にスタッフマスター）が最新であることを確認。
    2.  **本番用設定に切り替え (VS Code):**
        *   `Code.gs` 等の `IS_PRODUCTION` フラグを `true` に変更。
        *   必要に応じて `appsscript.json` の設定を確認・修正。
    3.  **記録:** `git commit -m "Feat: Prepare for production deployment"`。
    4.  **本番GASプロジェクトへ Push:**
        *   ローカルの `.clasp.json` の `scriptId` を **本番用スクリプトID** に一時的に書き換えるか、`clasp push --force` （注意して使用）するか、本番用ブランチ/フォルダで管理する。 **推奨: 本番デプロイ用のGitブランチ (例: `main` または `release`) を用意し、そこにマージしてから Push する。**
        *   `clasp push` を実行し、本番用GASプロジェクトにコードを反映。
    5.  **Webアプリとしてデプロイ (ターミナル):**
        *   `clasp deploy` コマンドを実行。
        *   初回デプロイの場合: `clasp deploy -d "Initial deployment" -V 1` のようにバージョン番号と説明を付与。表示される **WebアプリURL** と **実行可能API ID** を控える。
        *   更新デプロイの場合: `clasp deployments` で既存のデプロイメントIDを確認し、`clasp deploy -i <デプロイメントID> -d "機能Xの追加"` のように実行して更新。
    6.  **アクセス権限設定:** GASプロジェクトの設定や `clasp deploy` 時のオプションで、アクセスできるユーザー（組織内全員、特定のグループなど）を正しく設定する。

### **【進捗：未着手】Step 5: 運用と保守**

*   **目的:** アプリケーションの安定稼働を維持し、必要に応じて改善を行う。
*   **具体的な作業:**
    1.  **ユーザー展開:** 利用者への周知、操作マニュアル共有。
    2.  **フィードバック収集:** 利用状況のモニタリング、改善要望のヒアリング。
    3.  **保守サイクル:**
        *   不具合修正や機能改善は、まず **ローカル (開発ブランチ)** で行う。
        *   `git commit` で変更を記録。
        *   `.clasp.json` を **テスト用ID** に設定し、`clasp push` で **テスト環境** に反映。
        *   **テスト環境で徹底的にテスト**。
        *   問題なければ、**本番用ブランチにマージ**。
        *   `.clasp.json` を **本番用ID** に設定（またはブランチ切り替えで自動的に変わるように管理）。
        *   `clasp push` で **本番環境** に反映。
        *   `clasp deploy` で本番Webアプリを **更新**。
        *   このサイクルを厳守する。

---

## 5. テスト方法詳細

### 5.1 GAS関数の単体テスト

*   **方法1 (推奨):** ローカルのターミナルで `clasp run <関数名>` を実行。
    *   引数が必要な場合は、設定やラッパー関数を工夫。
    *   `console.log` はローカルには表示されないため、`Logger.log` を使い、GASエディタの実行ログで確認。
*   **方法2:** `clasp open` でブラウザエディタを開き、関数を選択して [デバッグ] または [実行]。`Logger.log` で確認。

### 5.2 Webアプリ結合テスト

*   `clasp push` 後、`clasp open` -> [デプロイ] > [テスト導入] で開発用URLを取得し、ブラウザでアクセス。
*   フロントエンドのデバッグは Chrome 開発者ツール ([検証] > [Console], [Network], [Application] タブ) をフル活用。

### 5.3 総合テスト

*   PCブラウザだけでなく、**スマートフォン実機** のブラウザでも開発用URLを開き、表示や操作性を確認。

---

## 6. デプロイ方法詳細

### 6.1 初回デプロイ

*   `clasp deploy -V 1 -d "Initial production deployment"`
*   表示される **Web アプリ URL** をユーザーに共有。

### 6.2 更新デプロイ

*   `clasp deployments` で最新のデプロイメントIDを確認。
*   `clasp deploy -i <デプロイメントID> -d "今回の更新内容の説明"`

### 6.3 デプロイバージョンの管理

*   `clasp deploy` を実行すると、GASプロジェクトに新しいバージョンが自動的に作成される。
*   ブラウザエディタの [デプロイ] > [デプロイメントを管理] から履歴を確認可能。
*   Gitのタグ機能 (例: `git tag v1.0`) と連携させると管理しやすい。

---

## 7. バージョン管理 (Git/GitHub)

*   **必須:** 全てのコード変更はGitで管理します。
*   **ブランチ戦略 (例):**
    *   `main`: 本番デプロイ用ブランチ。直接コミットせず、`develop` からマージ。
    *   `develop`: 開発のベースとなるブランチ。安定した機能がマージされる。
    *   `feature/xxx`: 機能追加や修正ごとの作業ブランチ。`develop` から分岐し、完了後に `develop` へマージ (Pull Request推奨)。
*   **コミット:** `git add .` -> `git commit -m " meaningful message"` をこまめに行う。
*   **リモートリポジトリ:** GitHub等に `git push` してバックアップと共有を行う。

---

## 8. 注意事項

*   **`clasp` 関連:**
    *   `.clasp.json`: Script ID が含まれるため、`.gitignore` に追加し、環境ごとに設定する。複数人で開発する場合、各自が適切な Script ID を設定する必要がある。
    *   `.claspignore`: 不要なファイルが Push されないように正しく設定する。
*   **`appsscript.json`:** マニフェストファイルはローカルで管理し、`clasp push` で反映させる。OAuthスコープの変更などはここで行う。
*   **複数人開発:** `git pull` をこまめに行い、コンフリクトが発生した場合は適切に解消する。
*   **環境変数:** スプレッドシートIDなどの環境依存の値は、`Code.gs` でのフラグ切り替えや、`.env` ファイルと `dotenv` のような仕組み (GASで利用するには工夫が必要) の導入を検討する。
*   **Node.js/claspバージョン:** 開発者間でバージョンをある程度揃えることが望ましい。