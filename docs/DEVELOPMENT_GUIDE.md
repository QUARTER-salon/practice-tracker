# 美容師練習管理Webアプリ 開発・運用ガイド (ローカル開発環境版)

## 1. はじめに：このガイドの目的

このガイドは、「美容師練習管理Webアプリ」の開発を、ローカル開発環境（VS Code, Git, clasp）を使用して効率的かつ安全に進めるための手順を説明するものです。

当初、`clasp push` コマンドに関する問題がありましたが、現在は解決済みであり、ローカル環境を主軸とした開発を行います。このガイドでは、ローカルでのコード編集、Gitによるバージョン管理、clasp を用いた Google Apps Script (GAS) プロジェクトとの連携、そしてテスト・デプロイまでの標準的なフローを示します。

## 2. 開発環境

*   **コードエディタ:** Visual Studio Code (VS Code) - 拡張機能 (Prettier, ESLint など推奨)
*   **バージョン管理:** Git, GitHub (リポジトリ: `practice-tracker` (テスト用), `trainingwebapp` (本番用))
*   **GAS連携ツール:** clasp v2.4.2 (`npm install -g @google/clasp@2.4.2` で特定バージョンをインストール推奨 ※最新版で `clasp open` 不具合あり)
*   **実行環境:** Node.js (clasp の実行に必要)
*   **Webブラウザ:** Google Chrome推奨 (動作確認、デバッグ、GASエディタ補助利用)
*   **Googleアカウント:** 開発権限のあるGoogle Workspaceアカウント (例: yujiro-funabashi@4uwb.com)
*   **Google Drive:** GASプロジェクトファイルの実体保管場所
*   **Google スプレッドシート:** アプリのデータベース（スタッフマスター、練習記録、在庫、各種マスター）

---

## 3. 開発プロジェクトの準備

安全な開発のため、必ずテスト用の環境を用意し、そこで開発・テストを行ってから本番環境に反映させます。

1.  **テスト用/本番用スプレッドシートの準備:**
    *   本番運用で使用するスプレッドシートとは別に、**テスト専用**のGoogleスプレッドシートファイルを作成します。（例: `[テスト用]美容師練習管理データ`）
    *   両方のスプレッドシート内に、要件定義に基づいた必要なシート（スタッフマスター, アプリ練習記録_RAW, ウィッグ在庫, 各種マスター）を作成し、ヘッダー行やテスト用のダミーデータを入力します。
    *   **テスト用** および **本番用** の両方の **スプレッドシートID** を控えておきます。（URLの `/d/` と `/edit` の間の文字列）
    *   **重要:** アプリにアクセスする全てのGoogleアカウント（スタッフマスターに登録されているアカウント）が、**両方のスプレッドシートに対して「編集者」権限を持っている**ことを確認してください。

2.  **ローカル開発ディレクトリの準備 (テスト用):**
    *   ローカルPCにテスト開発用のディレクトリ（フォルダ）を作成します。(例: `テスト練習アプリ`)
        ```bash
        mkdir テスト練習アプリ
        cd テスト練習アプリ
        ```
    *(注: 本番環境用のローカルディレクトリは別途 `練習WEBアプリ` として管理します)*

3.  **Gitリポジトリの初期化 (テスト用):**
    *   `テスト練習アプリ` ディレクトリ内でGitの管理を開始します。
        ```bash
        git init
        ```

4.  **GitHub リモートリポジトリの準備:**
    *   GitHubのウェブサイトで、テスト用のリポジトリ **`practice-tracker`** と、本番用のリポジトリ **`trainingwebapp`** を作成します (両方とも **Private** 推奨)。
    *   作成時には README, .gitignore, license を **追加しないでください** (空のリポジトリとして作成)。

5.  **GASプロジェクトとローカル環境の紐付け (テスト用):**
    *   準備済みの **テスト用GASプロジェクトのスクリプトID** を使って、`clasp clone <テスト用スクリプトID> --rootDir ./src` を実行し、コードをローカル (`テスト練習アプリ/src`) に取得します。
    *   `.clasp.json` が `テスト練習アプリ` 直下に作成されます。

6.  **設定ファイルの準備 (テスト用):**
    *   `.clasp.json`: クローン時に自動生成されます。**テスト用スクリプトID** が設定されていることを確認します。**`.gitignore` に追加してGit管理対象外にします。**
    *   `.gitignore`: **`テスト練習アプリ`** ディレクトリ直下に `.gitignore` ファイルを作成し、以下を記述します。
        ```gitignore
        # clasp 設定ファイル (環境依存)
        .clasp.json

        # Node.js モジュール (もし使う場合)
        node_modules/

        # OS 生成ファイル
        .DS_Store
        Thumbs.db

        # VS Code 設定
        .vscode/
        ```
    *   `appsscript.json`: `src` ディレクトリ内に存在します。必要に応じてVS Codeで編集します (タイムゾーン、OAuthスコープ、`webapp` 設定など)。**特に `webapp` の `executeAs` は `"USER_ACCESSING"` に設定し、`oauthScopes` に必要な権限が含まれているか確認してください。**

7.  **ローカルリポジトリとGitHubリポジトリの接続 (テスト用):**
    *   `テスト練習アプリ` ディレクトリ内で、以下のコマンドを実行します (`your-username` はご自身のGitHubユーザー名)。
        ```bash
        # リモートリポジトリを追加 (未設定の場合)
        # git remote add origin https://github.com/your-username/practice-tracker.git

        # ブランチ名を main に変更 (任意)
        # git branch -M main

        # 最初のコミットとプッシュ (未実行の場合)
        # git add .
        # git commit -m "Initial commit: Project setup"
        # git push -u origin main
        ```

8.  **ローカルコードの初期設定 (テスト用):**
    *   VS Code で **`テスト練習アプリ`** フォルダを開きます。
    *   `src/Code.gs` 内の `IS_PRODUCTION` フラグを `false` に設定し、`TEST_SPREADSHEET_ID` にテスト用スプレッドシートIDを設定します。
        ```javascript
        // 例: src/Code.gs
        const IS_PRODUCTION = false;
        const PROD_SPREADSHEET_ID = '【本番用スプレッドシートID】';
        const TEST_SPREADSHEET_ID = '【テスト用スプレッドシートID】';
        const SPREADSHEET_ID = IS_PRODUCTION ? PROD_SPREADSHEET_ID : TEST_SPREADSHEET_ID;
        // ... シート名定数 ...
        ```
    *   初期コードを `clasp push` で反映させます。

---

### 【補足】

*   テスト環境（ローカル `テスト練習アプリ` <-> GitHub `practice-tracker` <-> テスト用GASプロジェクト）の準備が整っています。
*   本番環境用のローカルディレクトリ (`練習WEBアプリ`) のセットアップは、テスト完了後に行います。
*   以降の「プロジェクトフォルダ」「ローカルディレクトリ」は **`テスト練習アプリ`** を指します。

---

## 4. 開発の進め方と現在の進捗

要件定義書に基づき、以下のステップで機能実装を進めます。コード編集は **VS Code**、バージョン管理は **Git/GitHub**、GASプロジェクトへの反映は **`clasp push`**、デプロイは **`clasp deploy`** で行います。

### **【進捗：完了】Step 0: コード基盤の整理と安定化**

*   **目的:** 保守性・安定性を高めるための基礎固め。
*   **実施内容:**
    *   設定値管理改善（`IS_PRODUCTION` フラグ導入）、関数整理（`Auth.js`, `Utils.js` などへ移動）、エラー処理強化、デバッグログ追加を実施。
    *   ログイン後の画面表示不具合をトラブルシューティングし、ファイル名の不一致 (`apps.html` -> `app.html`) が原因であることを特定・修正。
    *   ログイン成功時の画面遷移方法をURLパラメータに依存しないセッションフラグ方式 (`loggedIn` を `PropertiesService` に保存) に変更。
*   **状況:** コード基盤整理は完了。ログインおよびアプリ画面 (`app.html`)、管理者画面 (`admin.html`) の基本表示が正常に動作することを確認。

### **【進捗：実施中】Step 1: 機能実装と連携テスト**

*   **目的:** 要件定義に基づき、未実装の機能を実装し、連携動作を確認する。
*   **現在のサブステップ:** 管理者画面のCRUD機能実装。
*   **完了した作業:**
    *   管理者画面の基本的なHTML構造とJavaScript (`admin.html`, `admin_script.html`) を整備。
    *   各マスターデータのリスト表示機能 (`displayXXXList`) を実装。
    *   各マスターデータの追加機能 (`addXXX`) と削除機能 (`deleteXXX`) を実装。
    *   店舗管理 (`Stores`) と役職管理 (`Roles`) の編集機能 (`editXXX`, `updateXXX`) を実装。
    *   管理者画面の全リスト表示が正常に行われることを確認。追加・削除機能の基本的な動作を確認。
    *   管理者画面からのログ出力 (`logMessage`) が正常に機能することを確認。
*   **残っている課題・次のアクション:**
    1.  **管理者画面の編集機能実装:**
        *   トレーナー管理 (`Trainers`) の編集機能 (`editTrainer`, `updateTrainer`) を実装する。
        *   技術カテゴリー管理 (`TechCategories`) の編集機能 (`editTechCategory`, `updateTechCategory`) を実装する。
        *   詳細技術項目管理 (`TechDetails`) の編集機能 (`editTechDetail`, `updateTechDetail`) を実装する。
        *   各編集機能において、関連シートの整合性を保つための更新処理を実装する。
        *   編集モードと追加モードの切り替え（フォームの見出し、ボタンテキスト変更、キャンセルボタン表示など）をフロントエンド (`admin_script.html`) で実装する。
    2.  **練習記録画面の動的選択肢ロジック実装:** (Step 2 として後回しでも可)
        *   カテゴリ選択に応じた詳細項目リストの動的表示を実装・確認する。
        *   トレーナー選択に応じた評価欄・他店舗トレーナー欄の表示制御を実装・確認する。
    3.  **ID/PW認証のパスワードハッシュ化実装:** (後回しでも可)
        *   `Auth.js` の `validatePassword` 関数等を修正し、パスワードハッシュライブラリ (`BcryptGS` 等) を利用した検証を実装する。
        *   パスワード設定・変更機能が必要であれば別途実装する。

### **【進捗：未着手】Step 2: UI/UX 調整とエラーハンドリング強化**

*   **目的:** スマートフォンでの使いやすさ向上、エラー発生時のユーザー体験と開発者のデバッグ効率向上。
*   **具体的な作業 (VS Code & ブラウザ):**
    1.  **レスポンシブ対応:** スマートフォン実機やブラウザの開発者ツールで表示を確認し、`styles.html` (CSS) を調整。
    2.  **エラーハンドリング:** `try...catch` 構文を適切に配置し、ユーザー向けのエラーメッセージ（例: `alert()`, 画面表示）と、開発者向けのログ出力 (`Logger.log` や Stackdriver Logging) を充実させる。`google.script.run` の `.withFailureHandler()` を活用。
    3.  **入力バリデーション:** フロントエンド (JavaScript) での基本的なチェックに加え、バックエンド (GAS) でも受け取ったデータの妥当性を再度検証するコードを追加。
    4.  **記録と反映・テスト:** Step 1 と同様のサイクル (編集 -> commit -> push -> テスト導入URLで確認)。

### **【進捗：未着手】Step 3: コードレビューとリファクタリング**

*   **目的:** 実装したコード全体を見直し、品質、可読性、保守性をさらに向上させる。
*   **具体的な作業 (VS Code & GitHub):**
    1.  **自己レビュー/相互レビュー:** コード全体を読み返し、冗長な部分、複雑すぎる部分、コメント不足などを改善。可能であれば他の開発者にレビューを依頼 (GitHubのPull Request機能など活用)。
    2.  **リファクタリング:** レビュー結果に基づき、コードを整理・改善。
    3.  **記録:** `git commit`。

### **【進捗：未着手】Step 4: 本番デプロイ**

*   **目的:** テスト済みのアプリケーションを本番環境で利用可能にする。
*   **具体的な作業 (VS Code & ターミナル):**
    1.  **本番環境準備:** 本番用スプレッドシートのデータ（特にスタッフマスター）が最新であることを確認。
    2.  **本番用設定に切り替え (VS Code):**
        *   `Code.gs` 等の `IS_PRODUCTION` フラグを `true` に変更。
        *   必要に応じて `appsscript.json` の設定を確認・修正。
    3.  **記録:** `git commit -m "Feat: Prepare for production deployment"`。
    4.  **本番GASプロジェクトへ Push:**
        *   ローカルの `.clasp.json` の `scriptId` を **本番用スクリプトID** に一時的に書き換えるか、`clasp push --force` （注意して使用）するか、本番用ブランチ/フォルダで管理する。 **推奨: 本番デプロイ用のGitブランチ (例: `main` または `release`) を用意し、そこにマージしてから Push する。**
        *   `clasp push` を実行し、本番用GASプロジェクトにコードを反映。
    5.  **Webアプリとしてデプロイ (ターミナル):**
        *   `clasp deploy` コマンドを実行。
        *   初回デプロイの場合: `clasp deploy -d "Initial deployment" -V 1` のようにバージョン番号と説明を付与。表示される **WebアプリURL** と **実行可能API ID** を控える。
        *   更新デプロイの場合: `clasp deployments` で既存のデプロイメントIDを確認し、`clasp deploy -i <デプロイメントID> -d "機能Xの追加"` のように実行して更新。
    6.  **アクセス権限設定:** GASプロジェクトの設定や `clasp deploy` 時のオプションで、アクセスできるユーザー（組織内全員、特定のグループなど）を正しく設定する。

### **【進捗：未着手】Step 5: 運用と保守**

*   **目的:** アプリケーションの安定稼働を維持し、必要に応じて改善を行う。
*   **具体的な作業:**
    1.  **ユーザー展開:** 利用者への周知、操作マニュアル共有。
    2.  **フィードバック収集:** 利用状況のモニタリング、改善要望のヒアリング。
    3.  **保守サイクル:**
        *   不具合修正や機能改善は、まず **ローカル (開発ブランチ)** で行う。
        *   `git commit` で変更を記録。
        *   `.clasp.json` を **テスト用ID** に設定し、`clasp push` で **テスト環境** に反映。
        *   **テスト環境で徹底的にテスト**。
        *   問題なければ、**本番用ブランチにマージ**。
        *   `.clasp.json` を **本番用ID** に設定（またはブランチ切り替えで自動的に変わるように管理）。
        *   `clasp push` で **本番環境** に反映。
        *   `clasp deploy` で本番Webアプリを **更新**。
        *   このサイクルを厳守する。

---

## 5. テスト方法詳細

### 5.1 GAS関数の単体テスト

*   **方法1 (推奨):** ローカルのターミナルで `clasp run <関数名>` を実行。
    *   引数が必要な場合は、設定やラッパー関数を工夫。
    *   `console.log` はローカルには表示されないため、`Logger.log` を使い、GASエディタの実行ログで確認。
*   **方法2:** `clasp open` でブラウザエディタを開き、関数を選択して [デバッグ] または [実行]。`Logger.log` で確認。

### 5.2 Webアプリ結合テスト

*   `clasp push` 後、`clasp open` -> [デプロイ] > [テスト導入] で開発用URLを取得し、ブラウザでアクセス。
*   フロントエンドのデバッグは Chrome 開発者ツール ([検証] > [Console], [Network], [Application] タブ) をフル活用。

### 5.3 総合テスト

*   PCブラウザだけでなく、**スマートフォン実機** のブラウザでも開発用URLを開き、表示や操作性を確認。

---

## 6. デプロイ方法詳細

### 6.1 初回デプロイ

*   `clasp deploy -V 1 -d "Initial production deployment"`
*   表示される **Web アプリ URL** をユーザーに共有。

### 6.2 更新デプロイ

*   `clasp deployments` で最新のデプロイメントIDを確認。
*   `clasp deploy -i <デプロイメントID> -d "今回の更新内容の説明"`

### 6.3 デプロイバージョンの管理

*   `clasp deploy` を実行すると、GASプロジェクトに新しいバージョンが自動的に作成される。
*   ブラウザエディタの [デプロイ] > [デプロイメントを管理] から履歴を確認可能。
*   Gitのタグ機能 (例: `git tag v1.0`) と連携させると管理しやすい。

---

## 7. バージョン管理 (Git/GitHub)

*   **必須:** 全てのコード変更はGitで管理します。
*   **ブランチ戦略 (例):**
    *   `main`: 本番デプロイ用ブランチ。直接コミットせず、`develop` からマージ。
    *   `develop`: 開発のベースとなるブランチ。安定した機能がマージされる。
    *   `feature/xxx`: 機能追加や修正ごとの作業ブランチ。`develop` から分岐し、完了後に `develop` へマージ (Pull Request推奨)。
*   **コミット:** `git add .` -> `git commit -m " meaningful message"` をこまめに行う。
*   **リモートリポジトリ:** GitHub等に `git push` してバックアップと共有を行う。

---

## 8. 注意事項

*   **`clasp` 関連:**
    *   `.clasp.json`: Script ID が含まれるため、`.gitignore` に追加し、環境ごとに設定する。複数人で開発する場合、各自が適切な Script ID を設定する必要がある。
    *   `.claspignore`: 不要なファイルが Push されないように正しく設定する。
*   **`appsscript.json`:** マニフェストファイルはローカルで管理し、`clasp push` で反映させる。OAuthスコープの変更などはここで行う。
*   **複数人開発:** `git pull` をこまめに行い、コンフリクトが発生した場合は適切に解消する。
*   **環境変数:** スプレッドシートIDなどの環境依存の値は、`Code.gs` でのフラグ切り替えや、`.env` ファイルと `dotenv` のような仕組み (GASで利用するには工夫が必要) の導入を検討する。
*   **Node.js/claspバージョン:** 開発者間でバージョンをある程度揃えることが望ましい。


---

## 9. 開発支援 (AI アシスタントの活用)

このプロジェクトでは、開発効率の向上と問題解決の迅速化を目的として、AIアシスタント（大規模言語モデル、LLM）を積極的に活用しています。AIアシスタントには、主に以下の役割を期待しています。

**AIアシスタントの主な役割:**

1.  **コード分析とデバッグ支援:**
    *   提供されたコードスニペットやファイル全体の構造を分析し、潜在的な問題点や改善点を指摘する。
    *   エラーメッセージや実行ログに基づき、エラーの原因を特定し、解決策の候補を提案する。
2.  **コード生成とリファクタリング:**
    *   具体的な要件や指示に基づき、新しい機能や修正のためのコード（HTML, CSS, JavaScript, Google Apps Script）を生成・提案する。
    *   既存のコードを、可読性、保守性、パフォーマンスの観点から改善（リファクタリング）する案を提示する。
3.  **開発プロセスのナビゲーション:**
    *   Gitによるバージョン管理（コミットメッセージの提案、コマンド例の提示など）。
    *   `clasp` を用いたGASプロジェクトとの連携（`push`, `deploy` などのコマンド例と説明）。
    *   テストやデプロイの手順に関するガイダンス。
4.  **ドキュメント作成・更新支援:**
    *   README、要件定義書、開発ガイドなどのドキュメント内容の提案、修正、校正を行う。
    *   コメントの追加や変更履歴の記述を支援する。
5.  **次のステップと戦略提案:**
    *   プロジェクトの現在の状況（コード、進捗、課題）を理解し、次に進めるべき開発ステップや、問題解決のための戦略的なアプローチを複数提案する。
6.  **技術的な知識提供と壁打ち:**
    *   GAS、JavaScript、HTML/CSS、API連携、認証など、関連技術に関する質問に回答し、概念や実装方法を解説する。
    *   実装方針やアイデアに対するフィードバックを提供し、思考整理を助ける（壁打ち相手）。

**効果的なAIアシスタントの活用方法:**

*   **明確なコンテキストの提供:** コードの該当箇所、エラーメッセージ全文、関連するログ、実現したいこと、現在の問題点などを具体的に伝える。
*   **段階的な依頼:** 一度に多くのことを依頼せず、タスクを分割して具体的に指示する。
*   **フィードバックの提供:** AIの提案が期待通りでなかった場合、どの点が違ったのか、どう修正してほしいのかを具体的にフィードバックする。
*   **対話履歴の活用:** 必要に応じて過去のやり取りを提示し、文脈を思い出させる。

**留意事項:**

*   **最終判断は開発者:** AIアシスタントは強力なツールですが、提案されたコードや情報は必ず開発者自身がレビューし、その正確性、安全性、適切性を判断・保証する必要があります。
*   **思考停止の回避:** AIの提案を鵜呑みにせず、なぜその提案がなされたのかを理解し、自身の知識・経験と照らし合わせて採用・修正・却下を判断することが重要です。
*   **機密情報の管理:** パスワード、APIキー、個人情報などの機密データは、AIアシスタントとのやり取りに含めないように最大限注意してください。