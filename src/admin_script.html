<script>
  /**
   * 美容師練習管理アプリ - 管理者画面のJavaScript
   */
  document.addEventListener('DOMContentLoaded', function() {
    logToServer('admin_script.html: DOMContentLoaded 開始'); 
  
    // --- 初期化処理 ---
    try {
        setupTabs();
        loadAllData();
        setupFormListeners();
        setupNavButtons();
        setupStoreCancelButton(); 
        setupRoleCancelButton(); // ★ 役職キャンセルボタン初期化を追加
        // TODO: 他の管理項目のキャンセルボタンリスナーもここに追加
        logToServer('admin_script.html: 初期化完了');
    } catch(initError) {
        console.error("初期化エラー:", initError);
        logToServer('admin_script.html: 初期化エラー - ' + initError.toString());
        showMessage('管理画面の初期化に失敗しました。', 'error');
    }
  
    // --- タブ切り替え処理 ---
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabPanels = document.querySelectorAll('.tab-panel');
      
      if (tabButtons.length === 0 || tabPanels.length === 0) {
          console.error("タブ要素が見つかりません。");
          logToServer('setupTabs: タブボタンまたはパネル要素なし');
          return;
      }
  
      tabButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          // アクティブなタブボタンを変更
          tabButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          // タブIDに基づいてパネルを表示/非表示
          const tabId = this.id.replace('tab-', '');
          tabPanels.forEach(function(panel) {
            // 対応するパネルに active クラスを付与、他は削除
            panel.classList.toggle('active', panel.id === 'panel-' + tabId);
          });
        });
      });
      logToServer('setupTabs: 設定完了');
    }
    
    // --- 全データ読み込み ---
    function loadAllData() {
       logToServer('loadAllData: 開始');
      loadStores();
      loadRoles();
      loadTrainers();
      loadTechCategories();
      loadTechDetails();
      loadInventory();
       logToServer('loadAllData: 完了');
    }
    
    // --- フォームリスナー設定 ---
    function setupFormListeners() {
       logToServer('setupFormListeners: 開始');
      // 店舗フォーム
      const storeForm = document.getElementById('store-form');
      if (storeForm) storeForm.addEventListener('submit', handleStoreFormSubmit);
      else console.error("Element 'store-form' not found");
      
      // 役職フォーム
      const roleForm = document.getElementById('role-form');
       if (roleForm) roleForm.addEventListener('submit', handleRoleFormSubmit); // ★ 役職フォームリスナー
       else console.error("Element 'role-form' not found");
      
      // トレーナーフォーム
      const trainerForm = document.getElementById('trainer-form');
       if (trainerForm) trainerForm.addEventListener('submit', handleTrainerFormSubmit);
       else console.error("Element 'trainer-form' not found");
      
      // 技術カテゴリーフォーム
      const categoryForm = document.getElementById('category-form');
       if (categoryForm) categoryForm.addEventListener('submit', handleCategoryFormSubmit);
       else console.error("Element 'category-form' not found");
      
      // 詳細技術項目フォーム
      const detailForm = document.getElementById('detail-form');
       if (detailForm) detailForm.addEventListener('submit', handleDetailFormSubmit);
       else console.error("Element 'detail-form' not found");
      
      // ウィッグ在庫フォーム
      const inventoryForm = document.getElementById('inventory-form');
       if (inventoryForm) inventoryForm.addEventListener('submit', handleInventoryFormSubmit);
       else console.error("Element 'inventory-form' not found");
      
      // 「全ての役職」チェックボックス（カテゴリー）
      const categoryAllRolesCheckbox = document.getElementById('category-all-roles');
      if (categoryAllRolesCheckbox) {
          categoryAllRolesCheckbox.addEventListener('change', function() { /* ... */ });
      } else console.error("Element 'category-all-roles' not found");
      
      // 「全ての役職」チェックボックス（詳細項目）
      const detailAllRolesCheckbox = document.getElementById('detail-all-roles');
      if (detailAllRolesCheckbox) {
          detailAllRolesCheckbox.addEventListener('change', function() { /* ... */ });
      } else console.error("Element 'detail-all-roles' not found");
       logToServer('setupFormListeners: 完了');
    }
  
    // --- 店舗フォームのキャンセルボタンリスナー設定 ---
    function setupStoreCancelButton() {
        const cancelButton = document.getElementById('store-cancel-btn');
        if (cancelButton) {
            cancelButton.addEventListener('click', resetStoreForm);
            logToServer('setupStoreCancelButton: リスナー設定完了');
        } else {
            console.error("Element 'store-cancel-btn' not found");
            logToServer('setupStoreCancelButton: 要素が見つかりません');
        }
    }
  
    // ★★★ 役職フォームのキャンセルボタンリスナー設定 (新規追加) ★★★
    function setupRoleCancelButton() {
        const cancelButton = document.getElementById('role-cancel-btn');
        if (cancelButton) {
            cancelButton.addEventListener('click', resetRoleForm);
            logToServer('setupRoleCancelButton: リスナー設定完了');
        } else {
            console.error("Element 'role-cancel-btn' not found");
            logToServer('setupRoleCancelButton: 要素が見つかりません');
        }
    }
    // TODO: 他の管理項目にも同様のキャンセルボタン設定関数を追加
  
    // --- ナビゲーションボタン設定 ---
    function setupNavButtons() {
      // ... (変更なし) ...
       logToServer('setupNavButtons: 設定完了');
    }
    
    // ==================================
    // --- 店舗管理関数 ---
    // ==================================
    function loadStores() { /* ... (変更なし) ... */ }
    function displayStoreList(stores) { /* ... (変更なし) ... */ }
    function updateStoreSelects(stores) { /* ... (変更なし) ... */ }
    function deleteStore(storeName) { /* ... (変更なし) ... */ }
    function editStore(storeName) { /* ... (変更なし) ... */ }
    function resetStoreForm() { /* ... (変更なし) ... */ }
    function handleStoreFormSubmit(event) { /* ... (変更なし) ... */ }
    
    // ==================================
    // --- 役職管理関数 ---
    // ==================================
    function loadRoles() {
       logToServer('loadRoles: 開始');
      google.script.run
        .withSuccessHandler(function(result) {
           logToServer('loadRoles: Success, success=' + result?.success);
          if (result.success) {
            displayRoleList(result.data);
            updateRoleCheckboxes(result.data); 
          } else {
            showMessage(result.message || '役職情報の取得に失敗しました。', 'error');
          }
        })
        .withFailureHandler(function(error) {
           logToServer('loadRoles: Failure - ' + error.toString());
          showMessage('役職情報の取得中にエラーが発生しました: ' + error, 'error');
        })
        .getRoles(); // AdminHandler.js
    }
    
    // ★★★ displayRoleList を修正 ★★★
    function displayRoleList(roles) {
      const roleList = document.getElementById('role-list')?.querySelector('tbody');
       if (!roleList) { /* ... エラー処理 ... */ return; }
      roleList.innerHTML = ''; 
      logToServer('displayRoleList: 表示開始, 役職数=' + (roles ? roles.length : 0));
  
      if (roles && roles.length > 0) {
          roles.forEach(function(role) {
            const row = document.createElement('tr');
            const nameCell = document.createElement('td');
            nameCell.textContent = role;
            
            const actionCell = document.createElement('td');
            actionCell.style.whiteSpace = 'nowrap'; 
  
            // ★ 編集ボタンを作成 ★
            const editBtn = document.createElement('button');
            editBtn.textContent = '編集';
            editBtn.className = 'btn btn-small'; 
            editBtn.style.marginRight = '5px'; 
            editBtn.addEventListener('click', function() { editRole(role); }); // ★ 編集関数呼び出し
  
            // 削除ボタンを作成 (変更なし)
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '削除';
            deleteBtn.className = 'btn btn-small btn-danger';
            deleteBtn.addEventListener('click', function() {
              if (confirm(`「${role}」を削除してもよろしいですか？\n関連データも変更される可能性があります。`)) {
                deleteRole(role);
              }
            });
            
            actionCell.appendChild(editBtn); // ★ 編集ボタンを追加
            actionCell.appendChild(deleteBtn);
            row.appendChild(nameCell);
            row.appendChild(actionCell);
            roleList.appendChild(row);
          });
      } else {
           // データがない場合の表示
          const row = roleList.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 2; 
          cell.textContent = '登録されている役職はありません。';
          cell.style.textAlign = 'center';
          cell.style.padding = '15px';
      }
       logToServer('displayRoleList: 表示完了');
    }
    
    // ★★★ 役職編集モード設定関数 (新規作成) ★★★
    function editRole(roleName) {
        logToServer('editRole: 開始 - 役職名=' + roleName); 
        try {
            document.getElementById('role-form-title').textContent = '役職編集';
            document.getElementById('role-name').value = roleName;
            document.getElementById('role-edit-original-name').value = roleName; 
            document.getElementById('role-submit-btn').textContent = '更新'; 
            document.getElementById('role-cancel-btn').classList.remove('hidden'); 
            document.getElementById('role-name').focus();
        } catch (e) { /* ... エラー処理 ... */ }
    }
  
    // ★★★ 役職フォームリセット関数 (新規作成) ★★★
    function resetRoleForm() {
        logToServer('resetRoleForm: 開始'); 
        try {
            document.getElementById('role-form-title').textContent = '役職追加';
            const form = document.getElementById('role-form');
            if (form) form.reset(); 
            document.getElementById('role-edit-original-name').value = ''; 
            document.getElementById('role-submit-btn').textContent = '追加'; 
            document.getElementById('role-cancel-btn').classList.add('hidden'); 
            showMessage('', ''); // メッセージクリア
        } catch (e) { /* ... エラー処理 ... */ }
    }
    
    // 役職チェックボックス更新 (変更なし)
    function updateRoleCheckboxes(roles) { /* ... (変更なし) ... */ }
  
    // 役職削除処理 (変更なし)
    function deleteRole(roleName) {
       logToServer('deleteRole: 開始 - 役職名=' + roleName);
       google.script.run
        .withSuccessHandler(function(result) {
           logToServer('deleteRole: Success, success=' + result?.success);
          if (result.success) {
            showMessage(result.message || '役職が削除されました。', 'success');
            loadRoles(); // ★ リストとチェックボックスを再読み込み
          } else {
            showMessage(result.message || '役職の削除に失敗しました。', 'error');
          }
        })
        .withFailureHandler(function(error) {
           logToServer('deleteRole: Failure - ' + error.toString());
          showMessage('役職の削除中にエラーが発生しました: ' + error, 'error');
        })
        .deleteRole(roleName); // AdminHandler.js
    }
    
    // ★★★ 役職フォーム送信処理 (編集モード判定追加) ★★★
    function handleRoleFormSubmit(event) {
      event.preventDefault();
      logToServer('handleRoleFormSubmit: 開始'); 
  
      const originalName = document.getElementById('role-edit-original-name').value;
      const roleNameInput = document.getElementById('role-name');
      const newName = roleNameInput ? roleNameInput.value.trim() : '';
      const submitBtn = document.getElementById('role-submit-btn');
  
      if (!newName) { /* ... エラー処理 ... */ return; }
      if (!submitBtn) { /* ... エラー処理 ... */ return; }
  
      submitBtn.disabled = true; 
  
      if (originalName) {
        // --- 編集モード ---
        logToServer('handleRoleFormSubmit: 編集モード実行 - 元=' + originalName + ', 新=' + newName);
        submitBtn.textContent = '更新中...';
        google.script.run
          .withSuccessHandler(function(result) {
             logToServer('handleRoleFormSubmit (更新): Success, success=' + result?.success);
            if (result.success) {
              showMessage(result.message || '役職情報が更新されました。', 'success');
              resetRoleForm(); 
              loadRoles(); // ★ リストとチェックボックスを再読み込み
            } else {
              showMessage(result.message || '役職情報の更新に失敗しました。', 'error');
              submitBtn.textContent = '更新'; 
            }
            if (submitBtn) submitBtn.disabled = false; 
          })
          .withFailureHandler(function(error) {
             logToServer('handleRoleFormSubmit (更新): Failure - ' + error.toString());
            showMessage('役職情報の更新中にエラーが発生しました: ' + error, 'error');
             if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '更新'; 
            }
          })
          .updateRole(originalName, newName); // ★ AdminHandler.js の更新関数
  
      } else {
        // --- 追加モード ---
         logToServer('handleRoleFormSubmit: 追加モード実行 - 新=' + newName);
        submitBtn.textContent = '追加中...';
        google.script.run
          .withSuccessHandler(function(result) {
             logToServer('handleRoleFormSubmit (追加): Success, success=' + result?.success);
            if (result.success) {
              showMessage(result.message || '役職が追加されました。', 'success');
              resetRoleForm(); 
              loadRoles(); // ★ リストとチェックボックスを再読み込み
            } else {
              showMessage(result.message || '役職の追加に失敗しました。', 'error');
               submitBtn.textContent = '追加'; 
            }
             if (submitBtn) submitBtn.disabled = false; 
          })
          .withFailureHandler(function(error) {
             logToServer('handleRoleFormSubmit (追加): Failure - ' + error.toString());
            showMessage('役職の追加中にエラーが発生しました: ' + error, 'error');
             if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '追加'; 
            }
          })
          .addRole(newName); // AdminHandler.js の追加関数
      }
    }
    
    // ==================================
    // --- トレーナー管理関数 ---
    // ==================================
    function loadTrainers() { /* ... (変更なし、編集ボタン対応必要) ... */ }
    function displayTrainerList(trainers) { /* ... (変更なし、編集ボタン対応必要) ... */ }
    function deleteTrainer(trainerName, storeName) { /* ... (変更なし) ... */ }
    function handleTrainerFormSubmit(event) { /* ... (変更なし、編集対応必要) ... */ }
    // TODO: editTrainer, resetTrainerForm, setupTrainerCancelButton
  
    // ==================================
    // --- 技術カテゴリー管理関数 ---
    // ==================================
    function loadTechCategories() { /* ... (変更なし、編集ボタン対応必要) ... */ }
    function displayCategoryList(categories) { /* ... (変更なし、編集ボタン対応必要) ... */ }
    function updateCategorySelect(categories) { /* ... (変更なし) ... */ }
    function deleteTechCategory(categoryName) { /* ... (変更なし) ... */ }
    function handleCategoryFormSubmit(event) { /* ... (変更なし、編集対応必要) ... */ }
     // TODO: editTechCategory, resetCategoryForm, setupCategoryCancelButton
  
    // ==================================
    // --- 詳細技術項目管理関数 ---
    // ==================================
    function loadTechDetails() { /* ... (変更なし、編集ボタン対応必要) ... */ }
    function displayDetailList(details) { /* ... (変更なし、編集ボタン対応必要) ... */ }
    function deleteTechDetail(detailName, categoryName) { /* ... (変更なし) ... */ }
    function handleDetailFormSubmit(event) { /* ... (変更なし、編集対応必要) ... */ }
     // TODO: editTechDetail, resetDetailForm, setupDetailCancelButton
    
    // ==================================
    // --- ウィッグ在庫管理関数 ---
    // ==================================
    function loadInventory() { /* ... (変更なし) ... */ }
    function displayInventoryList(inventory) { /* ... (変更なし) ... */ }
    function handleInventoryFormSubmit(event) { /* ... (変更なし) ... */ }
    
    // ==================================
    // --- 共通関数 ---
    // ==================================
    function showMessage(message, type) { /* ... (変更なし) ... */ }
    function logToServer(message) { /* ... (変更なし) ... */ }
  
  });
  </script>